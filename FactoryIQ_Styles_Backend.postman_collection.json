{
  "info": {
    "name": "FactoryIQ · Styles & Telegram Preview",
    "_postman_id": "c6c7d4a4-0b5e-4a51-9a0c-aaaa11112222",
    "description": "CRUD стилей и проверка применения стиля в /telegram/preview",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "0 · Env vars (readme)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Просто заметки:",
              "// 1) Укажи {{baseUrl}} в переменной окружения (например, http://localhost:8000)",
              "// 2) Укажи {{templateId}} — Id шаблона в ReportTemplates, где есть теги",
              "// 3) Для shift/weekly/monthly меняй {{periodType}}/**timeOfDay** при необходимости"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": { "method": "GET", "header": [], "url": "{{baseUrl}}/" }
    },
    {
      "name": "1 · Styles",
      "item": [
        {
          "name": "GET /styles · список",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/styles"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const arr = pm.response.json();",
                  "pm.expect(Array.isArray(arr)).to.be.true;",
                  "if (arr.length) {",
                  "  pm.environment.set('styleId', arr[0].id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "POST /styles · создать стиль (Corporate Light)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{baseUrl}}/styles",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Corporate Light\",\n  \"chart\": {\n    \"dpi\": 150,\n    \"size\": {\"w\": 1280, \"h\": 600},\n    \"layout\": {\"title\": {\"show\": true, \"align\": \"center\", \"fontSize\": 18, \"upper\": true}, \"legend\": {\"show\": true, \"position\": \"bottom\"}},\n    \"axes\": {\"x\": {\"rotation\": 20, \"tickFont\": 10, \"wrap\": 14, \"grid\": false}, \"y\": {\"tickFont\": 10, \"grid\": true, \"label\": \"Всего, т\"}},\n    \"bars\": {\"width\": 0.9, \"rounded\": true, \"showValueInside\": true, \"valuePrecision\": 1},\n    \"palette\": {\"type\": \"single-or-multi\", \"singleColor\": \"#2176C1\", \"multi\": [\"#2176C1\",\"#FFB100\",\"#FF6363\",\"#7FDBB6\",\"#6E44FF\",\"#F25F5C\",\"#007F5C\",\"#F49D37\",\"#A259F7\",\"#3A86FF\",\"#FF5C8A\",\"#FFC43D\"]},\n    \"background\": {\"color\": \"#FFFFFF\"},\n    \"watermark\": {\"text\": \"FactoryIQ\", \"opacity\": 0.12, \"position\": \"br\"}\n  },\n  \"table\": {\n    \"density\": \"compact\",\n    \"fontSize\": 13,\n    \"header\": {\"bg\": \"#F7F9FC\", \"color\": \"#0F172A\", \"bold\": true},\n    \"body\": {\"zebra\": true, \"zebraColor\": \"#FAFBFC\", \"borderColor\": \"#EEF1F6\", \"numberPrecision\": 1, \"thousandSep\": \" \", \"decimalSep\": \",\", \"alignNumbersRight\": true},\n    \"columns\": {\"autoWidth\": true, \"maxWidthPx\": 980, \"firstColWidthPct\": 68},\n    \"totals\": {\"show\": false, \"label\": \"Итого\"}\n  },\n  \"excel\": {\n    \"sheetName\": \"Отчет\",\n    \"freezeHeader\": true,\n    \"autoWidth\": true,\n    \"numberFormat\": \"# ##0.0\",\n    \"dateFormat\": \"yyyy-mm-dd hh:mm\"\n  },\n  \"is_default\": false\n}\n"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const body = pm.response.json();",
                  "pm.expect(body).to.have.property('id');",
                  "pm.environment.set('styleId', body.id);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "PUT /styles/:id · обновить стиль (смена цвета/сетки)",
          "request": {
            "method": "PUT",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{baseUrl}}/styles/{{styleId}}",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id\": {{styleId}},\n  \"name\": \"Corporate Light (updated)\",\n  \"chart\": {\"dpi\": 150, \"size\": {\"w\": 1280, \"h\": 600}, \"layout\": {\"title\": {\"show\": true, \"align\": \"center\", \"fontSize\": 18, \"upper\": false}, \"legend\": {\"show\": true, \"position\": \"bottom\"}}, \"axes\": {\"x\": {\"rotation\": 30, \"tickFont\": 10, \"wrap\": 13, \"grid\": false}, \"y\": {\"tickFont\": 10, \"grid\": false, \"label\": \"Тонны\"}}, \"bars\": {\"width\": 0.9, \"rounded\": true, \"showValueInside\": true, \"valuePrecision\": 1}, \"palette\": {\"type\": \"single-or-multi\", \"singleColor\": \"#1F6FEB\", \"multi\": [\"#1F6FEB\",\"#EC7A08\",\"#E5534B\",\"#3FBDA4\",\"#6E44FF\",\"#F25F5C\",\"#007F5C\"]}, \"background\": {\"color\": \"#FFFFFF\"}, \"watermark\": {\"text\": \"FactoryIQ\", \"opacity\": 0.1, \"position\": \"br\"}},\n  \"table\": {\"density\": \"compact\", \"fontSize\": 12, \"header\": {\"bg\": \"#F0F4FA\", \"color\": \"#0F172A\", \"bold\": true}, \"body\": {\"zebra\": true, \"zebraColor\": \"#FAFBFC\", \"borderColor\": \"#E2E8F0\", \"numberPrecision\": 1, \"thousandSep\": \" \", \"decimalSep\": \",\", \"alignNumbersRight\": true}, \"columns\": {\"autoWidth\": true, \"maxWidthPx\": 980, \"firstColWidthPct\": 68}, \"totals\": {\"show\": false, \"label\": \"Итого\"}},\n  \"excel\": {\"sheetName\": \"Отчет\", \"freezeHeader\": true, \"autoWidth\": true, \"numberFormat\": \"# ##0.0\", \"dateFormat\": \"yyyy-mm-dd hh:mm\"},\n  \"is_default\": false\n}\n"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const body = pm.response.json();",
                  "pm.expect(body.name).to.include('updated');"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "DELETE /styles/:id · удалить стиль",
          "request": {
            "method": "DELETE",
            "url": "{{baseUrl}}/styles/{{styleId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "pm.test('ok==true', () => pm.response.json().ok === true);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "2 · Telegram Preview",
      "item": [
        {
          "name": "POST /telegram/preview · chart (без override, по стилю шаблона)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{baseUrl}}/telegram/preview",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"template_id\": {{templateId}},\n  \"format\": \"chart\",\n  \"period_type\": \"weekly\"\n}\n"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const body = pm.response.json();",
                  "pm.test('ok', () => body.ok === true);",
                  "pm.test('Есть chart_png или серия', () => !!body.chart_png || (Array.isArray(body.chart_series) && body.chart_series.length>0));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "POST /telegram/preview · chart (override: единый красный)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{baseUrl}}/telegram/preview",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"template_id\": {{templateId}},\n  \"format\": \"chart\",\n  \"period_type\": \"weekly\",\n  \"style_override\": {\n    \"chart\": {\n      \"palette\": {\"type\": \"single\", \"singleColor\": \"#E11D48\"},\n      \"axes\": {\"x\": {\"rotation\": 0, \"wrap\": 10}, \"y\": {\"grid\": false, \"label\": \"Тонны\"}},\n      \"layout\": {\"title\": {\"show\": true, \"upper\": false, \"fontSize\": 16}}\n    }\n  }\n}\n"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const body = pm.response.json();",
                  "pm.test('ok', () => body.ok === true);",
                  "pm.test('PNG есть', () => !!body.chart_png);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "POST /telegram/preview · table (override: зебра/шапка)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{baseUrl}}/telegram/preview",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"template_id\": {{templateId}},\n  \"format\": \"table\",\n  \"period_type\": \"daily\",\n  \"style_override\": {\n    \"table\": {\n      \"fontSize\": 14,\n      \"header\": {\"bg\": \"#EEF2FF\", \"color\": \"#111827\", \"bold\": true},\n      \"body\": {\"zebra\": true, \"zebraColor\": \"#F8FAFC\", \"borderColor\": \"#E5E7EB\", \"numberPrecision\": 1}\n    }\n  }\n}\n"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const body = pm.response.json();",
                  "pm.test('ok', () => body.ok === true);",
                  "pm.test('Есть либо table_pngs, либо columns+data', () => (Array.isArray(body.table_pngs) && body.table_pngs.length>0) || (Array.isArray(body.columns) && body.columns.length>0));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "POST /telegram/preview · text (override таблицы применится к текстовым PNG, если баланс)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{baseUrl}}/telegram/preview",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"template_id\": {{templateId}},\n  \"format\": \"text\",\n  \"period_type\": \"daily\",\n  \"style_override\": {\n    \"table\": {\n      \"fontSize\": 12,\n      \"header\": {\"bg\": \"#F3F4F6\", \"color\": \"#111827\", \"bold\": true},\n      \"body\": {\"zebra\": false, \"borderColor\": \"#D1D5DB\"}\n    }\n  }\n}\n"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', () => pm.response.code === 200);",
                  "const body = pm.response.json();",
                  "pm.test('ok', () => body.ok === true);",
                  "pm.expect(body).to.have.property('text_table');"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:8000" },
    { "key": "templateId", "value": "1" },
    { "key": "periodType", "value": "weekly" },
    { "key": "timeOfDay", "value": "08:00:00" },
    { "key": "styleId", "value": "" }
  ]
}
